cubes:
  - name: subscription_performance
    title: Subscription performance
    description: Instantly access and analyze your subscription performance metrics
    sql: SELECT * FROM { COMPILE_CONTEXT.securityContext.dataset }.subscription_performance

    dimensions:
      - name: id
        title: id
        sql: date || source
        type: string
        primary_key: true

      - name: date
        title: Date
        description: The date of the results
        sql: TIMESTAMP(date)
        type: time

      - name: source
        title: Source
        description: The platform where the data originates from
        sql: source
        type: string

    measures:
      - name: orders
        title: Orders
        type: sum
        sql: orders
        format: number

      - name: invoices
        title: Invoices
        type: sum
        sql: invoices
        format: number

      - name: new_subscriptions
        title: New subscriptions
        type: sum
        sql: new_subscriptions
        format: number

      - name: new_subscriptions_starting_revenue
        title: Starting revenue for new subscriptions
        type: sum
        sql: new_subscriptions_starting_revenue
        format: number

      - name: average_subscription_starting_value
        title: Average subscription value for new subscriptions
        type: number
        sql: |
          CASE
            WHEN SUM(new_subscriptions) = 0 THEN 0
            ELSE SUM(new_subscriptions_starting_revenue) / SUM(new_subscriptions)
          END
        format: number

      - name: started_subscriptions
        title: Started subscriptions
        type: sum
        sql: started_subscriptions
        format: number

      - name: started_subscriptions_starting_revenue
        title: Starting revenue for started subscriptions
        type: sum
        sql: started_subscriptions_starting_revenue
        format: number

      - name: cancelled_subscriptions
        title: Cancelled subscriptions
        type: sum
        sql: cancelled_subscriptions
        format: number

      - name: paused_subscriptions
        title: Paused subscriptions
        type: sum
        sql: paused_subscriptions
        format: number

      - name: stopped_subscriptions
        title: Stopped subscriptions
        type: sum
        sql: stopped_subscriptions
        format: number

      - name: total_ending_subscriptions
        title: Total ending subscriptions
        type: sum
        sql: stopped_subscriptions + paused_subscriptions + cancelled_subscriptions
        format: number

      - name: net_subscriptions_change
        title: Net subscriptions change
        type: sum
        sql: new_subscriptions - stopped_subscriptions - paused_subscriptions - cancelled_subscriptions
        format: number

      - name: latest_total_active_subscriptions
        title: Latest total active subscriptions
        type: number
        sql: MAX_BY(total_active_subscriptions, date)
        format: number

      - name: new_taxes
        title: Taxes for new subscription sales
        type: sum
        sql: new_taxes
        format: number

      - name: new_shipping
        title: Shipping for new subscription sales
        type: sum
        sql: new_shipping
        format: number

      - name: new_discounts
        title: Discounts for new subscription sales
        type: sum
        sql: new_discounts
        format: number

      - name: new_returns
        title: Returns for new subscription sales
        type: sum
        sql: new_returns
        format: number

      - name: new_gross_sales
        title: Gross sales for new subscriptions
        type: sum
        sql: new_gross_sales
        format: number

      - name: new_net_sales
        title: Net sales for new subscriptions
        type: sum
        sql: new_net_sales
        format: number

      - name: new_total_sales
        title: Total sales for new subscriptions
        type: sum
        sql: new_total_sales
        format: number

    pre_aggregations:
