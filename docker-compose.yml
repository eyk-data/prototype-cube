version: "3"

services:
  cube:
    image: cubejs/cube:v0.36.0
    ports:
      - 4000:4000
    environment:
      - CUBEJS_DEV_MODE=true
      - CUBEJS_DB_TYPE=bigquery
      - CUBEJS_DB_BQ_KEY_FILE=/cube/conf/gcp-credentials.json
    volumes:
      - ./cube:/cube/conf
    env_file:
      - ./cube/.env
    restart: on-failure

  server:
    build: server
    ports:
      - 8000:80
    volumes:
      - ./server:/code/app
    env_file:
      - ./cube/.env
    restart: on-failure

  webapp:
    build: webapp
    ports:
      - 3001:3001
    volumes:
      - ./webapp/public:/app/public
      - ./webapp/src:/app/src
    environment:
      - PORT=3001
      - REACT_APP_CUBE_API_URL=http://localhost:4000/cubejs-api/v1
      - REACT_APP_USE_SELF_HOSTED_CUBE=true
      - REACT_APP_SERVER_URL=http://localhost:8000
    restart: on-failure
